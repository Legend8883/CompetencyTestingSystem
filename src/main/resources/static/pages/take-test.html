<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прохождение теста</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">Прохождение теста</div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div id="timer" class="timer">00:00</div>
                <button onclick="goToDashboard()" class="btn btn-outline">← Назад</button>
            </div>
        </nav>

        <main>
            <div id="test-container" style="max-width: 800px; margin: 0 auto;">
                <!-- Контент будет загружен через JavaScript -->
                <div style="text-align: center; padding: 3rem;">
                    Загрузка теста...
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentTestData = null;
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let secondsLeft = 0;

        async function loadTest() {
            const attemptId = sessionStorage.getItem('currentAttempt');
            if (!attemptId) {
                alert('Попытка не найдена');
                window.location.href = 'employee-dashboard.html';
                return;
            }

            try {
                const response = await apiService.getTestProgress(attemptId);
                currentTestData = response.data;
                
                // Сохраняем все вопросы в sessionStorage для быстрого доступа
                sessionStorage.setItem('testData', JSON.stringify(currentTestData));
                
                // Запускаем таймер
                startTimer(currentTestData.timeLeftMinutes * 60);
                
                // Отображаем первый вопрос
                displayQuestion(0);
                
            } catch (error) {
                console.error('Ошибка загрузки теста:', error);
                alert('Ошибка загрузки теста: ' + error.message);
                window.location.href = 'employee-dashboard.html';
            }
        }

        function displayQuestion(index) {
            if (!currentTestData || !currentTestData.currentQuestion) {
                console.error('Нет данных теста');
                return;
            }

            currentQuestionIndex = index;
            const question = currentTestData.currentQuestion;
            
            // Обновляем прогресс-бар
            updateProgressBar();
            
            // Отображаем вопрос
            const container = document.getElementById('test-container');
            
            let optionsHtml = '';
            if (question.type === 'OPEN_ANSWER') {
                optionsHtml = `
                    <div class="form-group">
                        <label>Ваш ответ:</label>
                        <textarea id="answer-text" rows="6" 
                                  placeholder="Введите ваш ответ здесь..."
                                  style="width: 100%; padding: 1rem; border: 1px solid var(--gray-border); border-radius: var(--radius);">${question.previousAnswer || ''}</textarea>
                    </div>
                `;
            } else if (question.options && question.options.length > 0) {
                const inputType = question.type === 'SINGLE_CHOICE' ? 'radio' : 'checkbox';
                const name = question.type === 'SINGLE_CHOICE' ? 'answer' : `answer-${question.id}`;
                
                optionsHtml = question.options.map(option => `
                    <label class="option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; margin-bottom: 0.5rem; border: 1px solid var(--gray-border); border-radius: var(--radius); cursor: pointer;">
                        <input type="${inputType}" name="${name}" value="${option.id}" 
                               ${question.previousSelectedOptions && question.previousSelectedOptions.includes(option.id) ? 'checked' : ''}>
                        <span>${option.text}</span>
                    </label>
                `).join('');
            }

            container.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h2>${currentTestData.testTitle}</h2>
                    <div style="color: var(--gray-text); margin-bottom: 1rem;">
                        Вопрос ${currentQuestionIndex + 1} из ${currentTestData.totalQuestions}
                    </div>
                </div>
                
                <div class="question-card" style="background: var(--white); padding: 2rem; border-radius: var(--radius-lg); border: 1px solid var(--gray-border);">
                    <h3 style="margin-bottom: 1.5rem;">${question.text}</h3>
                    
                    ${optionsHtml}
                    
                    <div id="save-status" style="margin-top: 1rem;"></div>
                </div>
                
                <div class="navigation-buttons" style="display: flex; justify-content: space-between; margin-top: 2rem;">
                    <button onclick="prevQuestion()" class="btn btn-outline" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                        ← Предыдущий
                    </button>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="saveAnswer()" class="btn btn-primary">
                            Сохранить ответ
                        </button>
                        
                        ${currentQuestionIndex === currentTestData.totalQuestions - 1 ? `
                            <button onclick="completeTest()" class="btn btn-success" style="background: var(--success);">
                                Завершить тест
                            </button>
                        ` : `
                            <button onclick="nextQuestion()" class="btn btn-primary">
                                Следующий →
                            </button>
                        `}
                    </div>
                </div>
                
                <div class="question-navigation" style="margin-top: 2rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                        ${currentTestData.questionProgress.map((q, index) => `
                            <button onclick="goToQuestion(${index})" 
                                    class="question-number ${q.answered ? 'answered' : ''} ${index === currentQuestionIndex ? 'current' : ''}"
                                    style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid ${q.answered ? 'var(--success)' : 'var(--gray-border)'}; 
                                           background: ${index === currentQuestionIndex ? 'var(--primary-blue)' : 'transparent'};
                                           color: ${index === currentQuestionIndex ? 'white' : 'var(--gray-dark)'};">
                                ${index + 1}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentTestData.totalQuestions - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            }
        }

        function goToQuestion(index) {
            if (index >= 0 && index < currentTestData.totalQuestions) {
                currentQuestionIndex = index;
                displayQuestion(currentQuestionIndex);
            }
        }

        async function saveAnswer() {
            const question = currentTestData.currentQuestion;
            const attemptId = sessionStorage.getItem('currentAttempt');
            
            if (!attemptId || !question) {
                showStatus('Ошибка: данные не найдены', 'error');
                return;
            }

            let answerData = {};
            
            if (question.type === 'OPEN_ANSWER') {
                const textarea = document.getElementById('answer-text');
                if (!textarea || !textarea.value.trim()) {
                    showStatus('Введите ответ', 'error');
                    return;
                }
                answerData = { 
                    questionId: question.id,
                    openAnswerText: textarea.value.trim() 
                };
            } else {
                const inputName = question.type === 'SINGLE_CHOICE' ? 'answer' : `answer-${question.id}`;
                const inputs = document.querySelectorAll(`input[name="${inputName}"]:checked`);
                
                if (inputs.length === 0) {
                    showStatus('Выберите хотя бы один вариант', 'error');
                    return;
                }
                
                const selectedIds = Array.from(inputs).map(input => parseInt(input.value));
                answerData = { 
                    questionId: question.id,
                    selectedOptionIds: selectedIds 
                };
            }

            try {
                showStatus('Сохранение...', 'info');
                
                const response = await apiService.submitAnswer(attemptId, answerData);
                
                // Обновляем прогресс вопроса
                if (currentTestData.questionProgress[currentQuestionIndex]) {
                    currentTestData.questionProgress[currentQuestionIndex].answered = true;
                }
                
                // Обновляем отображение
                updateProgressBar();
                
                showStatus('Ответ сохранен ✓', 'success');
                
                // Автоматически переходим к следующему вопросу через 1 секунду
                setTimeout(() => {
                    if (currentQuestionIndex < currentTestData.totalQuestions - 1) {
                        nextQuestion();
                    }
                }, 1000);
                
            } catch (error) {
                showStatus('Ошибка сохранения: ' + error.message, 'error');
            }
        }

        function updateProgressBar() {
            const progressItems = document.querySelectorAll('.question-number');
            progressItems.forEach((item, index) => {
                if (currentTestData.questionProgress[index]) {
                    const answered = currentTestData.questionProgress[index].answered;
                    item.style.borderColor = answered ? 'var(--success)' : 'var(--gray-border)';
                }
                item.style.background = index === currentQuestionIndex ? 'var(--primary-blue)' : 'transparent';
                item.style.color = index === currentQuestionIndex ? 'white' : 'var(--gray-dark)';
            });
        }

        function startTimer(totalSeconds) {
            secondsLeft = totalSeconds;
            
            const updateTimer = () => {
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    autoCompleteTest();
                }
                
                secondsLeft--;
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        async function completeTest() {
            if (!confirm('Завершить тест? После завершения изменить ответы будет нельзя.')) {
                return;
            }

            const attemptId = sessionStorage.getItem('currentAttempt');
            
            try {
                await apiService.completeTest(attemptId);
                
                clearInterval(timerInterval);
                sessionStorage.removeItem('currentAttempt');
                sessionStorage.removeItem('testData');
                
                alert('Тест завершен! Результаты будут доступны после проверки HR.');
                window.location.href = 'employee-dashboard.html';
                
            } catch (error) {
                alert('Ошибка завершения теста: ' + error.message);
            }
        }

        async function autoCompleteTest() {
            const attemptId = sessionStorage.getItem('currentAttempt');
            
            try {
                await apiService.completeTest(attemptId);
                
                sessionStorage.removeItem('currentAttempt');
                sessionStorage.removeItem('testData');
                
                alert('Время вышло! Тест автоматически завершен.');
                window.location.href = 'employee-dashboard.html';
                
            } catch (error) {
                console.error('Ошибка авто-завершения:', error);
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('save-status');
            if (!statusDiv) return;
            
            statusDiv.innerHTML = `
                <div class="${type === 'error' ? 'error-message' : 'success-message'}" style="margin: 0; padding: 0.75rem;">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        function goToDashboard() {
            if (confirm('Выйти из теста? Прогресс будет сохранен.')) {
                clearInterval(timerInterval);
                window.location.href = 'employee-dashboard.html';
            }
        }

        // Загружаем тест при открытии страницы
        document.addEventListener('DOMContentLoaded', async function() {
            await loadTest();
        });
    </script>
</body>
</html>