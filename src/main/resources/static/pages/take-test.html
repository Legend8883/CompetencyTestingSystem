<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
            justify-content: center;
        }

        .question-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            background: white;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .question-nav-btn:hover {
            border-color: #2563eb;
        }

        .question-nav-btn.current {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .question-nav-btn.answered {
            border-color: #10b981;
            background: #d1fae5;
        }

        .question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .option.selected {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .timer {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="navbar">
            <a href="employee-dashboard.html" class="nav-brand">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–µ—Å—Ç–∞–º</a>
            <div class="timer" id="timer">00:00</div>
        </nav>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ—Å—Ç–∞ (–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript) -->
        <div id="test-container">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Ç–µ—Å—Ç -->
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ============================================
        let testData = null;
        let currentQuestionIndex = 0;
        let totalQuestions = 0;
        let timerInterval = null;
        let secondsLeft = 0;
        let attemptId = null;
        let allQuestions = [];
        let testContainer = null;

        // ============================================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞
         */
        async function loadTest() {
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–µ—Å—Ç–∞...');

            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ—Å—Ç–∞ –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const testId = urlParams.get('id');

            console.log('üìå ID —Ç–µ—Å—Ç–∞ –∏–∑ URL:', testId);

            if (!testId) {
                showError('–¢–µ—Å—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç –Ω–∞ –ø–∞–Ω–µ–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.');
                return;
            }

            try {
                // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                testContainer = document.getElementById('test-container');
                if (!testContainer) {
                    console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Ç–µ—Å—Ç–∞');
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                testContainer.innerHTML = `
                    <div style="text-align: center; padding: 100px 20px;">
                        <div class="loading-spinner"></div>
                        <h2 style="margin-top: 20px; color: #1e40af;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–∞...</h2>
                        <p style="color: #64748b; margin-top: 10px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                    </div>
                `;

                // 1. –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç
                console.log('üìù –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç —Å ID:', testId);
                const startResponse = await apiService.startTest(testId);
                
                console.log('üìã –û—Ç–≤–µ—Ç –æ—Ç startTest:', startResponse);

                if (!startResponse.success || !startResponse.data) {
                    throw new Error(startResponse.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç');
                }

                attemptId = startResponse.data.attemptId;
                console.log('‚úÖ ID –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω:', attemptId);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                sessionStorage.setItem('currentAttempt', attemptId);
                sessionStorage.setItem('testId', testId);

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∞
                console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∞...');
                const progressResponse = await apiService.getTestProgress(attemptId);
                
                console.log('üìã –û—Ç–≤–µ—Ç getTestProgress:', progressResponse);

                if (!progressResponse.success || !progressResponse.data) {
                    throw new Error(progressResponse.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∞');
                }

                testData = progressResponse.data;
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞:', {
                    title: testData.testTitle,
                    totalQuestions: testData.totalQuestions,
                    currentQuestionIndex: testData.currentQuestionIndex
                });

                // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                await loadAllQuestions();

                // 4. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ—Å—Ç
                renderTest();

                console.log('üéâ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');

            } catch (error) {
                console.error('‚ùå –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –¢–ï–°–¢–ê:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ' + error.message);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç–µ—Å—Ç–∞
         */
        async function loadAllQuestions() {
            try {
                console.log('üìö –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏:', attemptId);
                
                const response = await apiService.getAllQuestions(attemptId);
                console.log('üìã –û—Ç–≤–µ—Ç getAllQuestions:', response);
                
                if (response.success && response.data) {
                    allQuestions = response.data;
                    totalQuestions = allQuestions.length;
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
                    allQuestions.sort((a, b) => (a.orderIndex || 0) - (b.orderIndex || 0));
                    
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤:', allQuestions.length);
                    
                    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–ø—Ä–æ—Å–∞—Ö
                    allQuestions.forEach((q, i) => {
                        console.log(`–í–æ–ø—Ä–æ—Å ${i + 1}: id=${q.id}, type=${q.type}, options=${q.options ? q.options.length : 0}`);
                    });
                } else {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–∑ API');
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ testData
                    if (testData && testData.totalQuestions) {
                        totalQuestions = testData.totalQuestions;
                        console.log('–ò—Å–ø–æ–ª—å–∑—É—é totalQuestions –∏–∑ testData:', totalQuestions);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
            }
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
         */
        function renderTest() {
            if (!testContainer) {
                console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            try {
                console.log('üé® –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–µ—Å—Ç–∞...');
                
                // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Ç–µ—Å—Ç–∞
                testContainer.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <!-- –®–∞–ø–∫–∞ —Ç–µ—Å—Ç–∞ -->
                        <div class="test-header">
                            <div>
                                <h1 id="test-title">${testData.testTitle || '–¢–µ—Å—Ç'}</h1>
                                <div id="test-info" style="color: #64748b; margin-top: 5px;">
                                    –í–æ–ø—Ä–æ—Å–æ–≤: ${totalQuestions} | 
                                    –í—Ä–µ–º—è: ${formatTime(testData.timeLeftMinutes || 30)}
                                </div>
                            </div>
                            <button onclick="completeTest()" class="btn btn-primary" id="complete-btn" style="display: none;">
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç
                            </button>
                        </div>

                        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div id="question-counter">–í–æ–ø—Ä–æ—Å 1 –∏–∑ ${totalQuestions}</div>
                                <div id="time-info">–í—Ä–µ–º—è: --:--</div>
                            </div>
                            <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                <div id="progress-bar" style="height: 100%; width: 0%; background: #2563eb; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º -->
                        <div class="question-nav" id="question-nav">
                            <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </div>

                        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ -->
                        <div id="question-area">
                            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å -->
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <button onclick="prevQuestion()" class="btn btn-outline" id="prev-btn" disabled>
                                ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å
                            </button>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="saveAnswer()" class="btn btn-primary" id="save-btn">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
                                </button>
                                <button onclick="nextQuestion()" class="btn btn-primary" id="next-btn">
                                    –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                        <div id="status-message" style="margin-top: 20px;"></div>
                    </div>
                `;

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç
                initializeTest();

                console.log('‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω');

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞ —Ç–µ—Å—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ—Å—Ç–∞: ' + error.message);
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∞
         */
        function initializeTest() {
            console.log('‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç...');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            currentQuestionIndex = testData.currentQuestionIndex || 0;
            secondsLeft = (testData.timeLeftMinutes || 30) * 60;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            createQuestionNavigation();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
            showQuestion(currentQuestionIndex);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            updateNavigation();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            startTimer();
            
            console.log('‚úÖ –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º
         */
        function createQuestionNavigation() {
            const navContainer = document.getElementById('question-nav');
            if (!navContainer) {
                console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            console.log('–°–æ–∑–¥–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –¥–ª—è', totalQuestions, '–≤–æ–ø—Ä–æ—Å–æ–≤');
            
            navContainer.innerHTML = '';
            
            for (let i = 0; i < totalQuestions; i++) {
                const btn = document.createElement('button');
                btn.className = 'question-nav-btn';
                btn.textContent = i + 1;
                btn.onclick = () => goToQuestion(i);
                navContainer.appendChild(btn);
            }
        }

        /**
         * –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É
         */
        async function goToQuestion(index) {
            console.log('–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–æ–ø—Ä–æ—Å—É:', index + 1);
            
            if (index < 0 || index >= totalQuestions) {
                console.error('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞:', index);
                return;
            }
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç
                await saveCurrentAnswer(false);
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ–≤–æ–º—É –≤–æ–ø—Ä–æ—Å—É
                currentQuestionIndex = index;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
                showQuestion(index);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                updateNavigation();
                
                console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—à–ª–∏ –∫ –≤–æ–ø—Ä–æ—Å—É', index + 1);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≤–æ–ø—Ä–æ—Å—É:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞: ' + error.message, 'error');
            }
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å –≤–æ–ø—Ä–æ—Å
         */
        function showQuestion(index) {
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å', index + 1, '–∏–∑', totalQuestions);
            
            const questionArea = document.getElementById('question-area');
            if (!questionArea) {
                console.error('–û–±–ª–∞—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å—ã
            if (allQuestions.length === 0) {
                questionArea.innerHTML = `
                    <div class="question-card">
                        <h3>–í–æ–ø—Ä–æ—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                    </div>
                `;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–æ–ø—Ä–æ—Å
            const question = allQuestions[index];
            if (!question) {
                console.error('–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –∏–Ω–¥–µ–∫—Å—É:', index);
                questionArea.innerHTML = `
                    <div class="question-card">
                        <h3>–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω</h3>
                    </div>
                `;
                return;
            }
            
            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å:', {
                id: question.id,
                type: question.type,
                text: question.text?.substring(0, 50) + '...'
            });
            
            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
            let optionsHtml = '';
            const questionId = question.id || index + 1;
            
            if (question.type === 'OPEN_ANSWER') {
                optionsHtml = `
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                            –í–∞—à –æ—Ç–≤–µ—Ç:
                        </label>
                        <textarea id="answer-text" rows="8" 
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."
                                  style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; resize: vertical;"
                                  maxlength="5000"></textarea>
                        <div style="text-align: right; color: #64748b; margin-top: 5px;">
                            –ú–∞–∫—Å–∏–º—É–º 5000 —Å–∏–º–≤–æ–ª–æ–≤
                        </div>
                    </div>
                `;
            } else if (question.type === 'SINGLE_CHOICE' || question.type === 'MULTIPLE_CHOICE') {
                const inputType = question.type === 'SINGLE_CHOICE' ? 'radio' : 'checkbox';
                const inputName = `q-${questionId}`;
                
                if (question.options && question.options.length > 0) {
                    optionsHtml = question.options.map((option, idx) => {
                        const optionId = option.id || idx + 1;
                        return `
                            <div class="option" onclick="selectOption(this, ${optionId}, '${question.type}', ${questionId})">
                                <input type="${inputType}" 
                                       name="${inputName}" 
                                       value="${optionId}"
                                       style="display: none;">
                                <div style="width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 50%; 
                                            display: flex; align-items: center; justify-content: center;">
                                </div>
                                <div style="flex: 1; font-size: 16px;">
                                    ${option.text || `–í–∞—Ä–∏–∞–Ω—Ç ${idx + 1}`}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    optionsHtml = '<p>–£ —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞</p>';
                }
            } else {
                optionsHtml = '<p>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞</p>';
            }
            
            questionArea.innerHTML = `
                <div class="question-card">
                    <h2 style="margin-bottom: 20px; color: #1e40af;">${question.text || `–í–æ–ø—Ä–æ—Å ${index + 1}`}</h2>
                    ${optionsHtml}
                </div>
            `;
            
            console.log('‚úÖ –í–æ–ø—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
        }

        /**
         * –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
         */
        function selectOption(element, optionId, questionType, questionId) {
            const inputName = `q-${questionId}`;
            
            if (questionType === 'SINGLE_CHOICE') {
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
                document.querySelectorAll(`input[name="${inputName}"]`).forEach(input => {
                    input.checked = false;
                    input.closest('.option').classList.remove('selected');
                });
                
                // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                element.querySelector('input').checked = true;
                element.classList.add('selected');
            } else {
                // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const input = element.querySelector('input');
                input.checked = !input.checked;
                element.classList.toggle('selected');
            }
            
            // –ü–æ–º–µ—á–∞–µ–º –≤–æ–ø—Ä–æ—Å –∫–∞–∫ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–π
            const navBtn = document.querySelectorAll('.question-nav-btn')[currentQuestionIndex];
            if (navBtn) {
                navBtn.classList.add('answered');
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
         */
        function updateNavigation() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.question-nav-btn').forEach((btn, i) => {
                btn.classList.toggle('current', i === currentQuestionIndex);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('question-counter').textContent =
                `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${totalQuestions}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').disabled = currentQuestionIndex === totalQuestions - 1;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤–æ–ø—Ä–æ—Å–µ
            document.getElementById('complete-btn').style.display =
                currentQuestionIndex === totalQuestions - 1 ? 'inline-block' : 'none';
                
            console.log('‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
         */
        async function saveCurrentAnswer(showMessage = true) {
            try {
                const question = allQuestions[currentQuestionIndex];
                if (!question) {
                    console.warn('–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    return false;
                }
                
                let answerData = {
                    questionId: question.id
                };
                
                const questionId = question.id || currentQuestionIndex + 1;
                
                if (question.type === 'OPEN_ANSWER') {
                    const textarea = document.getElementById('answer-text');
                    const answerText = textarea?.value.trim();
                    
                    if (!answerText) {
                        if (showMessage) showStatus('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å', 'warning');
                        return false;
                    }
                    
                    answerData.openAnswerText = answerText;
                } else {
                    const inputName = `q-${questionId}`;
                    const checkedInputs = document.querySelectorAll(`input[name="${inputName}"]:checked`);
                    
                    if (checkedInputs.length === 0) {
                        if (showMessage) showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞', 'warning');
                        return false;
                    }
                    
                    const selectedIds = Array.from(checkedInputs).map(input => parseInt(input.value));
                    answerData.selectedOptionIds = selectedIds;
                }
                
                console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç:', answerData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await apiService.submitAnswer(attemptId, answerData);
                
                if (response.success) {
                    if (showMessage) showStatus('–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    return true;
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', error);
                if (showMessage) showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                return false;
            }
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç (–ø—É–±–ª–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏)
         */
        async function saveAnswer() {
            await saveCurrentAnswer(true);
        }

        /**
         * –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
         */
        async function nextQuestion() {
            console.log('–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É');
            
            if (currentQuestionIndex < totalQuestions - 1) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
                await saveCurrentAnswer(false);
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
                updateNavigation();
            } else {
                showStatus('–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å', 'info');
            }
        }

        /**
         * –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å
         */
        async function prevQuestion() {
            console.log('–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É');
            
            if (currentQuestionIndex > 0) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
                await saveCurrentAnswer(false);
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
                updateNavigation();
            }
        }

        /**
         * –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
         */
        async function completeTest() {
            console.log('–ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç...');
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?\n\n–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –±—É–¥–µ—Ç –Ω–µ–ª—å–∑—è.')) {
                return;
            }
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç
                await saveCurrentAnswer(false);
                
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç
                const response = await apiService.completeTest(attemptId);
                console.log('–û—Ç–≤–µ—Ç –æ—Ç completeTest:', response);
                
                if (!response.success) {
                    throw new Error(response.message);
                }
                
                // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                sessionStorage.removeItem('currentAttempt');
                sessionStorage.removeItem('testId');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
                alert('‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ HR.');
                window.location.href = 'employee-dashboard.html';
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞: ' + error.message);
            }
        }

        /**
         * –¢–∞–π–º–µ—Ä
         */
        function startTimer() {
            console.log('–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä:', secondsLeft, '—Å–µ–∫—É–Ω–¥');
            
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                secondsLeft--;
                updateTimerDisplay();
                
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    autoCompleteTest();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            
            const timerElement = document.getElementById('timer');
            const timeInfoElement = document.getElementById('time-info');
            
            if (timerElement) {
                timerElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            if (timeInfoElement) {
                timeInfoElement.textContent = 
                    `–í—Ä–µ–º—è: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        async function autoCompleteTest() {
            try {
                console.log('‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç...');
                await apiService.completeTest(attemptId);
                
                sessionStorage.clear();
                alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ! –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.');
                window.location.href = 'employee-dashboard.html';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:', error);
            }
        }

        // ============================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            if (!statusDiv) return;
            
            const className = type === 'error' ? 'error-message' :
                            type === 'success' ? 'success-message' :
                            type === 'warning' ? 'warning-message' :
                            'info-message';
            
            statusDiv.innerHTML = `
                <div class="${className}" style="padding: 15px; border-radius: 8px; margin: 0;">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        function showError(message) {
            const container = document.getElementById('test-container') || document.body;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div style="color: #ef4444; font-size: 4rem; margin-bottom: 20px;">‚ùå</div>
                    <h3 style="color: #dc2626; margin-bottom: 15px;">–û—à–∏–±–∫–∞</h3>
                    <p style="margin-bottom: 20px; color: #334155;">${message}</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="window.location.href='employee-dashboard.html'" class="btn btn-primary">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–∞–º
                        </button>
                        <button onclick="location.reload()" class="btn btn-outline">
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;
        }

        function formatTime(minutes) {
            if (!minutes) return '0 –º–∏–Ω';
            if (minutes < 60) return `${minutes} –º–∏–Ω`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours} —á ${mins} –º–∏–Ω` : `${hours} —á`;
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (!token || !user || user.role !== 'EMPLOYEE') {
                console.warn('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞');
                window.location.href = '../login.html';
                return;
            }
            
            console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫:', user.email, '–†–æ–ª—å:', user.role);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç
            loadTest();
        });
    </script>
</body>
</html>