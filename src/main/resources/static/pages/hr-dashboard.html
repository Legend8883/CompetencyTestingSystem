<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR –ü–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="navbar">
            <a href="../index.html" class="nav-brand">HR –ü–∞–Ω–µ–ª—å</a>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span style="color: var(--gray-text); align-self: center;">HR</span>
                <button onclick="authService.logout()" class="btn btn-outline">–í—ã–π—Ç–∏</button>
            </div>
        </nav>

        <main>
            <div class="dashboard-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">HR</div>
                    <div>
                        <div id="userName"></div>
                        <div id="userEmail" style="font-size: 0.875rem; color: var(--gray-text);"></div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</h3>
                    <div class="stat-value" id="totalTests">0</div>
                </div>
                <div class="stat-card">
                    <h3>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
                    <div class="stat-value" id="totalEmployees">0</div>
                </div>
                <div class="stat-card">
                    <h3>–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h3>
                    <div class="stat-value" id="pendingReviews">0</div>
                </div>
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö</h3>
                    <div class="stat-value" id="activeTests">0</div>
                </div>
            </div>

            <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ actions-grid -->
            <div class="actions-grid" style="margin: 2rem 0;">
                <a href="create-test.html" class="action-card">
                    <div class="action-icon">üìù</div>
                    <h3>–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</h3>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Å—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏</p>
                </a>

                <a href="evaluation.html" class="action-card">
                    <div class="action-icon">üìã</div>
                    <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤</h3>
                    <p>–û—Ü–µ–Ω–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
                </a>

                <a href="#" class="action-card" onclick="showAssignModal()">
                    <div class="action-icon">üéØ</div>
                    <h3>–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ—Å—Ç</h3>
                    <p>–ù–∞–∑–Ω–∞—á—å—Ç–µ —Ç–µ—Å—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</p>
                </a>
            </div>

            <h3 style="margin: 2rem 0 1rem;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–µ—Å—Ç—ã</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–í–æ–ø—Ä–æ—Å—ã</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="testsTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">
                                –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>

        <footer class="footer">
            <p>HR –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º</p>
        </footer>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
    <div id="assignModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</h3>
                <button class="modal-close" onclick="closeAssignModal()">&times;</button>
            </div>
            <div class="modal-body" id="assignModalBody">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (!token || !user || user.role !== 'HR') {
                window.location.href = '../login.html';
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('userName').textContent = user.firstName + ' ' + user.lastName;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').textContent =
                (user.firstName[0] || '') + (user.lastName[0] || '');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç—ã
                const testsResponse = await apiService.getHRTests();
                const tests = testsResponse.data || [];

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                let pendingReviews = 0;
                try {
                    const evalResponse = await apiService.getAttemptsForEvaluation();
                    const evaluatingAttempts = evalResponse.data || [];
                    pendingReviews = evaluatingAttempts.filter(a => a.status === 'EVALUATING').length;
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ:', e);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('totalTests').textContent = tests.length;
                document.getElementById('activeTests').textContent = tests.filter(t => t.isActive).length;
                document.getElementById('pendingReviews').textContent = pendingReviews;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ç–µ—Å—Ç–æ–≤
                updateTestsTable(tests);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                try {
                    const employeesResponse = await apiService.getEmployees();
                    const employees = employeesResponse.data || [];
                    document.getElementById('totalEmployees').textContent = employees.length;
                } catch (empError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', empError);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', error);
                document.getElementById('testsTable').innerHTML = `
                    <tr><td colspan="5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>
                `;
            }
        }

        function updateTestsTable(tests) {
            const tbody = document.getElementById('testsTable');
            if (tests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤</td></tr>';
                return;
            }

            tbody.innerHTML = tests.slice(0, 10).map(test => `
                <tr>
                    <td>${test.title}</td>
                    <td>${test.questionCount || 0}</td>
                    <td>
                        <span class="status ${test.isActive ? 'status-active' : 'status-inactive'}">
                            ${test.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </td>
                    <td>${formatDate(test.createdAt)}</td>
                    <td>
                        <button class="btn btn-outline btn-small" onclick="showTestInfo(${test.id}, '${test.title.replace(/'/g, "\\'")}')">
                            –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ—Ç –¥–∞—Ç—ã';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU');
            } catch (e) {
                return dateString;
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
        async function showAssignModal() {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
                const modal = document.getElementById('assignModal');
                const modalBody = document.getElementById('assignModalBody');
                modal.style.display = 'flex';
                modalBody.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                const [testsRes, employeesRes] = await Promise.all([
                    apiService.getHRTests(),
                    apiService.getEmployees()
                ]);

                const tests = testsRes.data || [];
                const employees = employeesRes.data || [];

                if (tests.length === 0) {
                    modalBody.innerHTML = `
                        <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç.</p>
                        <button class="btn btn-primary" onclick="closeAssignModal(); window.location.href='create-test.html'">
                            –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç
                        </button>
                    `;
                    return;
                }

                if (employees.length === 0) {
                    modalBody.innerHTML = '<p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ—Å—Ç–∞</p>';
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç:</label>
                        <select id="assignTestId" class="form-control">
                            ${tests.filter(t => t.isActive).map(t =>
                                `<option value="${t.id}">${t.title} (${t.questionCount} –≤–æ–ø—Ä–æ—Å–æ–≤)</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (${employees.length} –≤—Å–µ–≥–æ):</label>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-border); padding: 1rem; border-radius: var(--radius); background: var(--white);">
                            ${employees.map(emp => `
                                <label class="employee-checkbox-label" style="display: block; margin-bottom: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: var(--radius); transition: background 0.2s;">
                                    <input type="checkbox" class="employee-checkbox" value="${emp.id}">
                                    <div style="display: inline-block; margin-left: 0.5rem;">
                                        <div style="font-weight: 500;">${emp.firstName} ${emp.lastName}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray-text);">${emp.email}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button type="button" onclick="selectAllEmployees()" class="btn btn-outline btn-small">
                                –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö
                            </button>
                            <button type="button" onclick="deselectAllEmployees()" class="btn btn-outline btn-small">
                                –°–Ω—è—Ç—å –≤—Å–µ—Ö
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>–î–µ–¥–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                        <input type="datetime-local" id="assignDeadline" class="form-control">
                    </div>
                    
                    <div id="assignError" class="error-message" style="display: none; margin-bottom: 1rem;"></div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn btn-outline" style="flex: 1;" onclick="closeAssignModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="assignTest()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                    </div>
                `;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(23, 59, 0);
                document.getElementById('assignDeadline').value = tomorrow.toISOString().slice(0, 16);

            } catch (error) {
                document.getElementById('assignModalBody').innerHTML = `
                    <p class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>
                    <button class="btn btn-outline" onclick="closeAssignModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
            }
        }

        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
        }

        function selectAllEmployees() {
            document.querySelectorAll('.employee-checkbox').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllEmployees() {
            document.querySelectorAll('.employee-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }

        async function assignTest() {
            const testId = document.getElementById('assignTestId').value;
            const deadline = document.getElementById('assignDeadline').value;
            const errorDiv = document.getElementById('assignError');

            errorDiv.style.display = 'none';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            if (!testId) {
                errorDiv.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç';
                errorDiv.style.display = 'block';
                return;
            }

            const selectedEmployees = Array.from(document.querySelectorAll('.employee-checkbox:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedEmployees.length === 0) {
                errorDiv.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
                errorDiv.style.display = 'block';
                return;
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–µ–¥–ª–∞–π–Ω –¥–ª—è API (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
            let deadlineISO = null;
            if (deadline) {
                const deadlineDate = new Date(deadline);
                deadlineISO = deadlineDate.toISOString();
            }

            try {
                const response = await apiService.assignTest(testId, selectedEmployees, deadlineISO);
                alert('–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω!');
                closeAssignModal();
                loadDashboardData(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function showTestInfo(testId, testTitle) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–∞
                const response = await fetch(`${API_BASE_URL}/hr/tests/${testId}`, {
                    headers: apiService.getHeaders()
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞');
                }

                const test = data.data;

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç–µ—Å—Ç–∞
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ—Å—Ç–∞
                let questionsHtml = '';
                if (test.questions && test.questions.length > 0) {
                    questionsHtml = `
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--secondary-blue);">–í–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞ (${test.questions.length})</h4>
                        <div style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                            ${test.questions.map((question, index) => `
                                <div style="margin-bottom: 1.5rem; padding: 1.25rem; border: 1px solid var(--gray-border); border-radius: var(--radius); background: var(--white);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                        <strong style="color: var(--primary-blue);">–í–æ–ø—Ä–æ—Å ${index + 1}</strong>
                                        <span class="badge" style="background: ${getQuestionTypeColor(question.type)}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">
                                            ${getQuestionTypeLabel(question.type)}
                                        </span>
                                    </div>
                                    
                                    <p style="margin-bottom: 1rem; line-height: 1.5;">${question.text}</p>
                                    
                                    ${question.type !== 'OPEN_ANSWER' && question.options ? `
                                        <div style="margin-top: 1rem;">
                                            <div style="font-weight: 500; color: var(--gray-text); margin-bottom: 0.5rem;">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:</div>
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                ${question.options.map((option, optIndex) => `
                                                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: var(--radius); background: ${option.isCorrect ? 'var(--success-light)' : 'var(--gray-light)'}; border: 1px solid ${option.isCorrect ? 'var(--success)' : 'var(--gray-border)'};">
                                                        <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: ${option.isCorrect ? 'var(--success)' : 'var(--white)'}; color: ${option.isCorrect ? 'white' : 'var(--gray-text)'}; border-radius: 50%; font-weight: 600;">
                                                            ${optIndex + 1}
                                                        </div>
                                                        <div style="flex: 1;">
                                                            ${option.text}
                                                        </div>
                                                        ${option.isCorrect ?
                                                            '<span style="color: var(--success); font-weight: 600; font-size: 0.875rem;">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π</span>' :
                                                            ''
                                                        }
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="margin-top: 1rem;">
                                            <div style="font-weight: 500; color: var(--gray-text); margin-bottom: 0.5rem;">–¢–∏–ø –æ—Ç–≤–µ—Ç–∞:</div>
                                            <div style="padding: 0.75rem; background: var(--gray-light); border-radius: var(--radius); border: 1px solid var(--gray-border);">
                                                –û—Ç–∫—Ä—ã—Ç—ã–π –æ—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç–æ–≤—ã–π)
                                            </div>
                                        </div>
                                    `}
                                    
                                    <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-border); display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--gray-text); font-size: 0.875rem;">
                                            –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: <strong style="color: var(--primary-blue);">${question.maxScore}</strong>
                                        </span>
                                        <span style="color: var(--gray-text); font-size: 0.875rem;">
                                            –ü–æ—Ä—è–¥–æ–∫: <strong>${question.orderIndex + 1}</strong>
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>${test.title}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1.5rem;">
                            ${test.description ? `
                                <p style="margin-bottom: 1rem; color: var(--gray-dark); line-height: 1.5;">
                                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${test.description}
                                </p>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="padding: 1rem; background: var(--primary-verylight); border-radius: var(--radius);">
                                    <div style="font-size: 0.875rem; color: var(--gray-text); margin-bottom: 0.25rem;">–í—Ä–µ–º—è</div>
                                    <div style="font-weight: 600; color: var(--primary-blue);">${test.timeLimitMinutes} –º–∏–Ω—É—Ç</div>
                                </div>
                                
                                <div style="padding: 1rem; background: var(--primary-verylight); border-radius: var(--radius);">
                                    <div style="font-size: 0.875rem; color: var(--gray-text); margin-bottom: 0.25rem;">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª</div>
                                    <div style="font-weight: 600; color: var(--primary-blue);">${test.passingScore}</div>
                                </div>
                                
                                <div style="padding: 1rem; background: var(--primary-verylight); border-radius: var(--radius);">
                                    <div style="font-size: 0.875rem; color: var(--gray-text); margin-bottom: 0.25rem;">–°—Ç–∞—Ç—É—Å</div>
                                    <div>
                                        <span class="status ${test.isActive ? 'status-active' : 'status-inactive'}">
                                            ${test.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="padding: 1rem; background: var(--primary-verylight); border-radius: var(--radius);">
                                    <div style="font-size: 0.875rem; color: var(--gray-text); margin-bottom: 0.25rem;">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
                                    <div style="font-weight: 600; color: var(--primary-blue);">${formatDate(test.createdAt)}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${questionsHtml}
                        
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-border); display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn ${test.isActive ? 'btn-outline' : 'btn-primary'}" 
                                    onclick="toggleTestStatus(${test.id}, ${test.isActive})">
                                ${test.isActive ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                            <button class="btn btn-primary" 
                                    onclick="assignSpecificTest(${test.id}, '${test.title}')">
                                –ù–∞–∑–Ω–∞—á–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç
                            </button>
                        </div>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ' + error.message);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
        function getQuestionTypeLabel(type) {
            const types = {
                'SINGLE_CHOICE': '–û–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç',
                'MULTIPLE_CHOICE': '–ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤',
                'OPEN_ANSWER': '–û—Ç–∫—Ä—ã—Ç—ã–π –æ—Ç–≤–µ—Ç'
            };
            return types[type] || type;
        }

        function getQuestionTypeColor(type) {
            const colors = {
                'SINGLE_CHOICE': 'var(--primary-blue)',
                'MULTIPLE_CHOICE': 'var(--warning)',
                'OPEN_ANSWER': 'var(--success)'
            };
            return colors[type] || 'var(--gray-text)';
        }

        async function toggleTestStatus(testId, isActive) {
            try {
                if (isActive) {
                    await apiService.deactivateTest(testId);
                    alert('–¢–µ—Å—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                } else {
                    await apiService.activateTest(testId);
                    alert('–¢–µ—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                loadDashboardData();

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                document.querySelector('.modal').remove();

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
            }
        }

        function assignSpecificTest(testId, testTitle) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–∞–ª–∫—É
            document.querySelector('.modal').remove();

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å –ø—Ä–µ–¥–≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–µ—Å—Ç–æ–º
            showAssignModal();

            // –ü–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π —Ç–µ—Å—Ç
            setTimeout(() => {
                const select = document.getElementById('assignTestId');
                if (select) {
                    select.value = testId;
                }
            }, 100);
        }
    </script>
</body>
</html>