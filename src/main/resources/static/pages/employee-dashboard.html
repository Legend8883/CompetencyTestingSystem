<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель сотрудника</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="navbar">
            <a href="../index.html" class="nav-brand">Панель сотрудника</a>
            <div style="display: flex; gap: 1rem;">
                <span style="color: var(--gray-text); align-self: center;">Сотрудник</span>
                <button onclick="authService.logout()" class="btn btn-outline">Выйти</button>
            </div>
        </nav>

        <main>
            <div class="dashboard-header">
                <h2>Доступные тесты</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userInitials"></div>
                    <div>
                        <div id="userName"></div>
                        <div id="userEmail" style="font-size: 0.875rem; color: var(--gray-text);"></div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Доступно тестов</h3>
                    <div class="stat-value" id="availableTests">0</div>
                </div>
                <div class="stat-card">
                    <h3>Пройдено</h3>
                    <div class="stat-value" id="completedTests">0</div>
                </div>
                <div class="stat-card">
                    <h3>Средний балл</h3>
                    <div class="stat-value" id="averageScore">0</div>
                </div>
                <div class="stat-card">
                    <h3>Успешность</h3>
                    <div class="stat-value" id="successRate">0%</div>
                </div>
            </div>

            <h3 style="margin: 2rem 0 1rem;">Доступные для прохождения</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Название теста</th>
                            <th>Вопросы</th>
                            <th>Время</th>
                            <th>Проходной балл</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="testsTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">
                                Загрузка тестов...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 style="margin: 2rem 0 1rem;">История тестирований</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Тест</th>
                            <th>Дата</th>
                            <th>Балл</th>
                            <th>Статус</th>
                            <th>Результат</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">
                                История тестирований пуста
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>

        <footer class="footer">
            <p>Панель сотрудника</p>
        </footer>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Проверяем авторизацию и загружаем данные
        document.addEventListener('DOMContentLoaded', async function () {
            // Проверка авторизации
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (!token || !user || user.role !== 'EMPLOYEE') {
                window.location.href = '../login.html';
                return;
            }

            // Отображаем информацию пользователя
            document.getElementById('userName').textContent = user.firstName + ' ' + user.lastName;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userInitials').textContent =
                (user.firstName[0] || '') + (user.lastName[0] || '');

            // Загружаем данные
            await loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                // Показываем загрузку
                document.getElementById('testsTable').innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">
                    Загрузка доступных тестов...
                </td>
            </tr>
        `;

                // Загружаем доступные тесты
                const testsResponse = await apiService.getAvailableTests();
                const tests = testsResponse.data || [];

                // Загружаем мои попытки
                let myAttempts = [];
                try {
                    const attemptsResponse = await apiService.getMyAttempts();
                    myAttempts = attemptsResponse.data || [];
                    console.log('My attempts loaded:', myAttempts);
                } catch (attemptsError) {
                    console.error('Error loading attempts:', attemptsError);
                }

                // Получаем ID тестов, которые уже сданы или на проверке
                const completedTestIds = myAttempts
                    .filter(attempt =>
                        attempt.status === 'EVALUATED' ||
                        attempt.status === 'EVALUATING' ||
                        attempt.status === 'COMPLETED'
                    )
                    .map(attempt => attempt.testId);

                console.log('Пройденные тесты ID:', completedTestIds);
                console.log('Все тесты:', tests.map(t => ({ id: t.id, title: t.title, isActive: t.isActive })));

                // Фильтруем тесты
                const availableTests = tests.filter(test => {
                    const isActive = test.isActive;
                    const notCompleted = !completedTestIds.includes(test.id);
                    console.log(`Тест ${test.id} "${test.title}": активен=${isActive}, не пройден=${notCompleted}`);
                    return isActive && notCompleted;
                });

                console.log('Available tests after filtering:', availableTests);

                // Обновляем статистику
                document.getElementById('availableTests').textContent = availableTests.length;

                // Статистика по пройденным тестам
                const evaluatedAttempts = myAttempts.filter(attempt =>
                    attempt.status === 'EVALUATED'
                );

                document.getElementById('completedTests').textContent = evaluatedAttempts.length;

                if (evaluatedAttempts.length > 0) {
                    const avgScore = evaluatedAttempts.reduce((sum, a) => sum + (a.score || 0), 0) / evaluatedAttempts.length;
                    const passedTests = evaluatedAttempts.filter(a => a.passed).length;
                    const successRate = (passedTests / evaluatedAttempts.length) * 100;

                    document.getElementById('averageScore').textContent = Math.round(avgScore);
                    document.getElementById('successRate').textContent = Math.round(successRate) + '%';
                }

                // Обновляем таблицу тестов
                updateTestsTable(availableTests);

                // Обновляем таблицу истории
                updateHistoryTable(evaluatedAttempts);

            } catch (error) {
                console.error('Ошибка загрузки дашборда:', error);
                document.getElementById('testsTable').innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--error);">
                    Ошибка загрузки тестов: ${error.message}
                </td>
            </tr>
        `;
            }
        }

        // Добавьте эти вспомогательные функции:
        function updateTestsTable(tests) {
            const tbody = document.getElementById('testsTable');

            if (tests.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">
                    Нет доступных тестов
                </td>
            </tr>
        `;
            } else {
                tbody.innerHTML = tests.map(test => `
            <tr>
                <td>
                    <strong>${test.title}</strong>
                    ${test.description ? `<br><small style="color: var(--gray-text);">${test.description}</small>` : ''}
                </td>
                <td>${test.questionCount || 0}</td>
                <td>${formatTime(test.timeLimitMinutes)}</td>
                <td>${test.passingScore}%</td>
                <td>
                    <button class="btn btn-primary btn-small" 
                            onclick="startTest(${test.id})">
                        Начать тест
                    </button>
                </td>
            </tr>
        `).join('');
            }
        }

        async function viewResults(attemptId) {
            // Открываем в ЭТОЙ же вкладке
            window.location.href = `test-results.html?attemptId=${attemptId}&view=employee`;
        }

        async function viewAttemptDetails(attemptId) {
            // Для попыток на проверке тоже показываем в этой же вкладке
            window.location.href = `test-results.html?attemptId=${attemptId}&view=employee`;
        }

        function updateHistoryTable(attempts) {
            const tbody = document.getElementById('historyTable');

            if (attempts.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem;">
                    История тестирований пуста
                </td>
            </tr>
        `;
                return;
            }

            tbody.innerHTML = attempts.map(attempt => {
                // Определяем статус для отображения
                let statusText = getAttemptStatusLabel(attempt.status);
                let statusClass = getAttemptStatusClass(attempt.status);
                let buttonText = '';
                let buttonClass = '';
                let buttonAction = '';

                // Для статуса "На проверке" (COMPLETED или EVALUATING)
                if (attempt.status === 'COMPLETED' || attempt.status === 'EVALUATING') {
                    buttonText = 'Просмотреть ответы';
                    buttonClass = 'btn-warning';
                    // Используем текущую вкладку, а не новую
                    buttonAction = `viewAttemptDetails(${attempt.id})`;
                } else if (attempt.status === 'EVALUATED') {
                    // Проверено - зеленая кнопка
                    buttonText = 'Результаты';
                    buttonClass = 'btn-success';
                    // Используем текущую вкладку
                    buttonAction = `viewResults(${attempt.id})`;
                } else if (attempt.status === 'IN_PROGRESS') {
                    buttonText = 'Продолжить';
                    buttonClass = 'btn-primary';
                    buttonAction = `continueTest(${attempt.testId})`;
                } else {
                    buttonText = 'Подробнее';
                    buttonClass = 'btn-outline';
                    buttonAction = `viewAttemptDetails(${attempt.id})`;
                }

                // Определяем результат
                let resultHtml = '';
                if (attempt.status === 'EVALUATED') {
                    if (attempt.passed) {
                        resultHtml = '<span style="color: var(--success);">✓ Прошел</span>';
                    } else {
                        resultHtml = '<span style="color: var(--error);">✗ Не прошел</span>';
                    }
                } else if (attempt.status === 'COMPLETED' || attempt.status === 'EVALUATING') {
                    statusText = 'На проверке HR'; // Явно указываем статус
                    resultHtml = '<span style="color: var(--warning);">⏳ Ожидает проверки HR</span>';
                } else {
                    resultHtml = '<span style="color: var(--gray-text);">—</span>';
                }

                return `
            <tr>
                <td>${attempt.testTitle}</td>
                <td>${formatDate(attempt.completedAt || attempt.startedAt)}</td>
                <td>
                    ${attempt.score !== null && attempt.score !== undefined ?
                        `${attempt.score} баллов` :
                        '—'}
                </td>
                <td>
                    <span class="status ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td>${resultHtml}</td>
                <td>
                    <button class="btn ${buttonClass} btn-small" onclick="${buttonAction}">
                        ${buttonText}
                    </button>
                </td>
            </tr>
        `;
            }).join('');
        }

        // Функция продолжения теста
        function continueTest(testId) {
            // Начинаем тест заново или продолжаем существующий
            window.location.href = `take-test.html?id=${testId}`;
        }

        // Модальное окно с результатами
        function showResultsModal(results) {
            let questionsHtml = '';

            if (results.questions && results.questions.length > 0) {
                questionsHtml = results.questions.map((q, index) => `
            <div class="question-result ${q.isCorrect ? 'correct-answer' : 'incorrect-answer'}">
                <h4>Вопрос ${index + 1}: ${q.questionText}</h4>
                
                ${q.questionType === 'OPEN_ANSWER' ? `
                    <p><strong>Ваш ответ:</strong> ${q.userAnswer || 'Нет ответа'}</p>
                    <p><strong>Оценка:</strong> ${q.assignedScore || q.autoScore} / ${q.questionMaxScore}</p>
                ` : `
                    <p><strong>Ваши варианты:</strong></p>
                    <div class="options-list">
                        ${q.selectedOptions.map(option => `
                            <div class="option-result ${option.isCorrect ? 'option-correct' : ''} 
                                 ${option.selected ? 'option-selected' : ''}">
                                ${option.text}
                                ${option.isCorrect ? ' ✓' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <p><strong>Баллы:</strong> ${q.finalScore} / ${q.questionMaxScore}</p>
                `}
                
                <p><strong>Результат:</strong> ${q.isCorrect ? '✓ Правильно' : '✗ Неправильно'}</p>
            </div>
        `).join('');
            }

            Utils.createModal(`Результаты теста: ${results.testTitle}`, `
        <div class="test-summary">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <div>
                    <p><strong>Общий балл:</strong> ${results.score} / ${results.maxPossibleScore}</p>
                    <p><strong>Проходной балл:</strong> ${results.passingScore}</p>
                    <p><strong>Результат:</strong> 
                        <span style="color: ${results.passed ? 'green' : 'red'}; font-weight: bold;">
                            ${results.passed ? 'ТЕСТ ПРОЙДЕН' : 'ТЕСТ НЕ ПРОЙДЕН'}
                        </span>
                    </p>
                </div>
                <div>
                    <p><strong>Дата завершения:</strong> ${formatDate(results.completedAt)}</p>
                    <p><strong>Правильных ответов:</strong> ${results.correctAnswersCount} / ${results.totalQuestions}</p>
                </div>
            </div>
        </div>
        
        <h3 style="margin-top: 20px;">Детали ответов:</h3>
        <div style="max-height: 400px; overflow-y: auto;">
            ${questionsHtml || '<p>Нет данных по вопросам</p>'}
        </div>
    `, { width: '800px' });
        }

        // Модальное окно с деталями попытки (для статуса "На проверке")
        function showAttemptDetailsModal(attemptDetails) {
            let answersHtml = '';

            if (attemptDetails.answers && attemptDetails.answers.length > 0) {
                answersHtml = attemptDetails.answers.map((answer, index) => `
            <div class="answer-detail">
                <h4>Вопрос ${index + 1}: ${answer.questionText}</h4>
                
                ${answer.questionType === 'OPEN_ANSWER' ? `
                    <p><strong>Ваш ответ:</strong></p>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        ${answer.openAnswerText || 'Нет ответа'}
                    </div>
                    <p><strong>Статус:</strong> Ожидает оценки HR</p>
                ` : `
                    <p><strong>Ваши варианты:</strong></p>
                    <div class="options-list">
                        ${answer.selectedOptions.map(option => `
                            <div class="option-result ${option.selected ? 'option-selected' : ''}">
                                ${option.text}
                            </div>
                        `).join('')}
                    </div>
                    <p><strong>Авто-оценка:</strong> ${answer.autoScore} / ${answer.maxScore}</p>
                `}
            </div>
        `).join('');
            }

            Utils.createModal(`Попытка теста: ${attemptDetails.testTitle}`, `
        <div class="attempt-info">
            <p><strong>Статус:</strong> <span class="status status-pending">На проверке HR</span></p>
            <p><strong>Дата завершения:</strong> ${formatDate(attemptDetails.completedAt)}</p>
            <p><strong>Авто-оценка:</strong> ${attemptDetails.autoScore || 0} баллов</p>
            <p><em>Тест отправлен на проверку HR. Вы не можете изменить ответы.</em></p>
        </div>
        
        <h3 style="margin-top: 20px;">Ваши ответы:</h3>
        <div style="max-height: 400px; overflow-y: auto;">
            ${answersHtml || '<p>Нет данных по ответам</p>'}
        </div>
    `, { width: '800px' });
        }

        function getAttemptStatusClass(status) {
            switch (status) {
                case 'EVALUATED': return 'status-active';
                case 'EVALUATING': return 'status-pending';
                case 'COMPLETED': return 'status-inactive';
                default: return 'status-inactive';
            }
        }

        function getAttemptStatusLabel(status) {
            const statuses = {
                'IN_PROGRESS': 'В процессе',
                'COMPLETED': 'На проверке',  // ВАЖНО: COMPLETED = На проверке
                'EVALUATING': 'На проверке HR',
                'EVALUATED': 'Проверено',
                'SUBMITTED': 'Отправлен'
            };
            return statuses[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Нет данных';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU');
            } catch (e) {
                return dateString;
            }
        }

        async function viewTestResult(attemptId) {
            try {
                // Здесь можно реализовать просмотр детальных результатов
                // Пока просто покажем alert
                const attemptsResponse = await apiService.getMyAttempts();
                const attempt = attemptsResponse.data?.find(a => a.id === attemptId);

                if (attempt) {
                    alert(`Результаты теста "${attempt.testTitle}":\n\n` +
                        `Оценка: ${attempt.score || 'Нет оценки'}\n` +
                        `Статус: ${attempt.passed ? 'Прошел ✓' : 'Не прошел ✗'}\n` +
                        `Дата: ${formatDate(attempt.completedAt)}`);
                }
            } catch (error) {
                console.error('Ошибка загрузки результатов:', error);
                alert('Ошибка загрузки результатов: ' + error.message);
            }
        }

        function formatTime(minutes) {
            if (!minutes) return '0 мин';
            if (minutes < 60) {
                return `${minutes} мин`;
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours} ч ${mins} мин` : `${hours} ч`;
        }

        function startTest(testId) {
            // Переходим на страницу прохождения теста
            window.location.href = `take-test.html?id=${testId}`;
        }
    </script>
</body>

</html>