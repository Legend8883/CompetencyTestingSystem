<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤ - HR –ü–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="navbar">
            <a href="../index.html" class="nav-brand">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤</a>
            <div style="display: flex; gap: 1rem;">
                <a href="hr-dashboard.html" class="btn btn-outline">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å</a>
                <button onclick="authService.logout()" class="btn btn-outline">–í—ã–π—Ç–∏</button>
            </div>
        </nav>

        <main>
            <div class="auth-card" style="max-width: 1000px; margin: 0 auto;">
                <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
                <p class="auth-subtitle">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>

                <div id="evaluation-container">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                    <div class="loading" style="text-align: center; padding: 3rem;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏...
                    </div>
                </div>

                <h3 style="margin: 2rem 0 1rem;">–ü–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h3>
                <div id="attempts-container" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                                <th>–ê–≤—Ç–æ-–æ—Ü–µ–Ω–∫–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="attempts-table">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—ã—Ç–æ–∫...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤ - HR –ü–∞–Ω–µ–ª—å</p>
        </footer>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ HR
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (!token || !user || user.role !== 'HR') {
                window.location.href = '../login.html';
                return;
            }

            await loadEvaluationData();
        });

        async function loadEvaluationData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                const openAnswersResponse = await apiService.getOpenAnswers();
                const openAnswers = openAnswersResponse.data || [];

                console.log('Open answers for evaluation:', openAnswers);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
                const attemptsResponse = await apiService.getAttemptsForEvaluation();
                const attempts = attemptsResponse.data || [];

                console.log('Attempts for evaluation:', attempts);

                renderOpenAnswers(openAnswers);
                renderAttemptsTable(attempts);

                console.log('–°—Ç–∞—Ç—É—Å—ã –ø–æ–ø—ã—Ç–æ–∫:', attempts.map(a => ({
                    id: a.id,
                    status: a.status,
                    test: a.testTitle
                })));

                // –§–∏–ª—å—Ç—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º EVALUATING
                const evaluatingAttempts = attempts.filter(a => a.status === 'EVALUATING');
                console.log('–ü–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ:', evaluatingAttempts.length);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('evaluation-container').innerHTML = `
            <div class="error-message">
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
            </div>
        `;
            }
        }

        function renderOpenAnswers(answers) {
            const container = document.getElementById('evaluation-container');

            if (answers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: var(--gray-light); border-radius: var(--radius);">
                        <h3 style="color: var(--gray-text); margin-bottom: 1rem;">üéâ –û—Ç–ª–∏—á–Ω–æ!</h3>
                        <p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏. –í—Å–µ –æ—Ç–≤–µ—Ç—ã —É–∂–µ –æ—Ü–µ–Ω–µ–Ω—ã.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: var(--secondary-blue);">
                            –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (${answers.length})
                        </h3>
                        <div style="font-size: 0.875rem; color: var(--gray-text);">
                            –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –∑–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —É–∫–∞–∑–∞–Ω –≤ —Å–∫–æ–±–∫–∞—Ö
                        </div>
                    </div>
                    
                    <div id="answers-list" style="max-height: 500px; overflow-y: auto; padding-right: 0.5rem;">
                        ${answers.map(answer => `
                            <div class="answer-card" data-answer-id="${answer.id}" style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid var(--gray-border); border-radius: var(--radius); background: var(--white);">
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-weight: 600; color: var(--gray-dark); margin-bottom: 0.25rem;">
                                        –í–æ–ø—Ä–æ—Å:
                                    </div>
                                    <div style="padding: 1rem; background: var(--gray-light); border-radius: var(--radius); border-left: 4px solid var(--primary-blue);">
                                        ${answer.questionText}
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-weight: 600; color: var(--gray-dark); margin-bottom: 0.25rem;">
                                        –û—Ç–≤–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
                                    </div>
                                    <div style="padding: 1rem; background: var(--primary-verylight); border-radius: var(--radius); white-space: pre-wrap; font-family: monospace; font-size: 0.875rem;">
                                        ${answer.openAnswerText || '–û—Ç–≤–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                            –û—Ü–µ–Ω–∫–∞ (0 - ${answer.maxScore} –±–∞–ª–ª–æ–≤):
                                        </label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="number" 
                                                   class="score-input" 
                                                   min="0" 
                                                   max="${answer.maxScore}"
                                                   value="${answer.assignedScore || 0}"
                                                   style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-border); border-radius: var(--radius);">
                                            <span style="color: var(--gray-text);">/ ${answer.maxScore}</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <button onclick="saveScore(${answer.id})" class="btn btn-primary">
                                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="status-${answer.id}" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function saveScore(answerId) {
            const answerCard = document.querySelector(`.answer-card[data-answer-id="${answerId}"]`);
            const scoreInput = answerCard.querySelector('.score-input');
            const statusDiv = document.getElementById(`status-${answerId}`);

            const score = parseInt(scoreInput.value);
            const maxScore = parseInt(scoreInput.max);

            if (score < 0 || score > maxScore) {
                statusDiv.innerHTML = '<span style="color: var(--error);">–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ ' + maxScore + '</span>';
                return;
            }

            try {
                statusDiv.innerHTML = '<span style="color: var(--gray-text);">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>';
                await apiService.evaluateAnswer(answerId, score);

                statusDiv.innerHTML = '<span style="color: var(--success);">‚úì –û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</span>';

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                    loadEvaluationData();
                }, 2000);

            } catch (error) {
                statusDiv.innerHTML = '<span style="color: var(--error);">–û—à–∏–±–∫–∞: ' + error.message + '</span>';
            }
        }

        function renderAttemptsTable(attempts) {
            const tbody = document.getElementById('attempts-table');

            if (attempts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            –ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = attempts.map(attempt => `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${attempt.user.firstName} ${attempt.user.lastName}</div>
                        <div style="font-size: 0.875rem; color: var(--gray-text);">${attempt.user.email}</div>
                    </td>
                    <td>${attempt.testTitle}</td>
                    <td>${formatDate(attempt.completedAt)}</td>
                    <td>
                        ${attempt.score !== null ? attempt.score + ' –±–∞–ª–ª–æ–≤' : '–ù–µ –æ—Ü–µ–Ω–µ–Ω'}
                    </td>
                    <td>
                        <span class="status ${getAttemptStatusClass(attempt.status)}">
                            ${getAttemptStatusLabel(attempt.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="viewAttemptDetails(${attempt.id})">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        ${attempt.status === 'EVALUATING' ? `
                            <button class="btn btn-outline btn-small" onclick="completeEvaluation(${attempt.id})">
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dateString;
            }
        }

        function getAttemptStatusClass(status) {
            switch (status) {
                case 'EVALUATING': return 'status-pending';
                case 'EVALUATED': return 'status-active';
                case 'COMPLETED': return 'status-inactive';
                default: return 'status-inactive';
            }
        }

        function getAttemptStatusLabel(status) {
            const statuses = {
                'IN_PROGRESS': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
                'COMPLETED': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                'EVALUATING': '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
                'EVALUATED': '–ü—Ä–æ–≤–µ—Ä–µ–Ω'
            };
            return statuses[status] || status;
        }

        async function viewAttemptDetails(attemptId) {
            try {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –ø–æ–ø—ã—Ç–∫–∏
                alert('–î–µ—Ç–∞–ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –±—É–¥—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏. ID –ø–æ–ø—ã—Ç–∫–∏: ' + attemptId);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function completeEvaluation(attemptId) {
            if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —ç—Ç–æ–π –ø–æ–ø—ã—Ç–∫–∏? –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                await apiService.completeEvaluation(attemptId);
                alert('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.');
                loadEvaluationData();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
            }
        }
    </script>
</body>

</html>