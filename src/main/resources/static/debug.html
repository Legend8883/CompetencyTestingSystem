<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug HR Panel</title>
</head>

<body>
    <h1>Debug HR Panel</h1>
    <div>
        <button onclick="loginAsHR()">1. Login as HR</button>
        <button onclick="getOpenAnswers()">2. Get Open Answers</button>
        <button onclick="getEvaluationAttempts()">3. Get Evaluation Attempts</button>
        <button onclick="getAllAttempts()">4. Get All Attempts</button>
    </div>
    <pre id="output" style="background: #f5f5f5; padding: 10px; max-height: 500px; overflow-y: auto;"></pre>

    <script src="js/api.js"></script>
    <script>
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += msg + '\n';
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('output').textContent = '';
        }

        async function loginAsHR() {
            clearLog();
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ HR –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await apiService.login('hr@company3.com', 'hrpassword123');
                log('‚úÖ HR Login successful');
                log('User: ' + JSON.stringify(apiService.user, null, 2));

                // –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–æ–ª—å
                if (apiService.user.role !== 'HR') {
                    log('‚ö†Ô∏è WARNING: User is not HR! Role: ' + apiService.user.role);
                }
            } catch (e) {
                log('‚ùå HR Login error: ' + e.message);

                // –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å HR –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (e.message.includes('–ù–µ–≤–µ—Ä–Ω—ã–π email')) {
                    log('Trying to register HR user...');
                    try {
                        const registerResponse = await apiService.registerHR({
                            email: 'hr@company.com',
                            firstName: 'HR',
                            lastName: 'Manager',
                            password: 'password123',
                            confirmPassword: 'password123'
                        });
                        log('HR registration successful, trying to login again...');
                        await loginAsHR();
                    } catch (regError) {
                        log('‚ùå HR Registration error: ' + regError.message);
                    }
                }
            }
        }

        async function getOpenAnswers() {
            clearLog();
            try {
                const response = await apiService.getOpenAnswers();
                log('üìã Open answers for evaluation:');
                log(JSON.stringify(response, null, 2));

                if (response.data && response.data.length > 0) {
                    log(`\nFound ${response.data.length} open answers to evaluate`);
                } else {
                    log('No open answers to evaluate');
                }
            } catch (e) {
                log('‚ùå Error getting open answers: ' + e.message);
            }
        }

        async function getEvaluationAttempts() {
            clearLog();
            try {
                const response = await apiService.getAttemptsForEvaluation();
                log('üìã Attempts for evaluation:');
                log(JSON.stringify(response, null, 2));

                if (response.data && response.data.length > 0) {
                    log(`\nFound ${response.data.length} attempts to evaluate`);
                    response.data.forEach(attempt => {
                        log(`Attempt ID: ${attempt.id}, User: ${attempt.user.firstName} ${attempt.user.lastName}, Status: ${attempt.status}`);
                    });
                } else {
                    log('No attempts for evaluation');
                }
            } catch (e) {
                log('‚ùå Error getting evaluation attempts: ' + e.message);
            }
        }

        async function getAllAttempts() {
            clearLog();
            try {
                // Get all attempts from different endpoints
                const [employeeAttempts, evaluationAttempts] = await Promise.all([
                    fetch('http://localhost:8080/api/employee/attempts', {
                        headers: apiService.getHeaders()
                    }).then(r => r.json()),
                    fetch('http://localhost:8080/api/hr/evaluation/attempts', {
                        headers: apiService.getHeaders()
                    }).then(r => r.json())
                ]);

                log('üìã All Employee Attempts:');
                log(JSON.stringify(employeeAttempts, null, 2));

                log('\nüìã HR Evaluation Attempts:');
                log(JSON.stringify(evaluationAttempts, null, 2));

            } catch (e) {
                log('‚ùå Error getting all attempts: ' + e.message);
            }
        }

        function checkCurrentUser() {
            const user = apiService.user;
            console.log('Current user:', user);
            log('Current user role: ' + (user?.role || 'Not logged in'));
        }

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            log('Token exists: ' + !!token);
            log('User exists: ' + !!user);
            if (user) {
                log('User role: ' + user.role);
                log('User email: ' + user.email);
            }

            // –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
            const headers = apiService.getHeaders();
            log('Request headers:');
            log(JSON.stringify(headers, null, 2));
        }
    </script>
</body>

</html>